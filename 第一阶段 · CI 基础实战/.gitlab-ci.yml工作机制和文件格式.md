å¥½çš„ï¼Œè¿™æ¬¡æˆ‘ä»¬æŠŠ **`.gitlab-ci.yml` çš„å·¥ä½œæœºåˆ¶**æ‹†å¼€è®²ï¼Œå½»åº•ç†è§£å®ƒèƒŒåçš„æµæ°´çº¿é€»è¾‘ ğŸ§©ã€‚
æˆ‘ä¼šä»æœ€åº•å±‚å¼€å§‹ï¼Œç¡®ä¿ä½ æ˜ç™½**GitLab CI æ€ä¹ˆâ€œçœ‹â€è¿™ä¸ªæ–‡ä»¶ï¼Œæ€ä¹ˆæ‰§è¡Œ jobï¼Œä»¥åŠç¼“å­˜ã€ä¾èµ–ã€Runner æ˜¯æ€ä¹ˆä¸²èµ·æ¥çš„**ã€‚

---

## ä¸€ã€GitLab CI æ ¸å¿ƒæ¦‚å¿µ

1. **Pipelineï¼ˆæµæ°´çº¿ï¼‰**

   * æ¯æ¬¡ pushã€merge request æˆ–æ‰‹åŠ¨è§¦å‘æ—¶ç”Ÿæˆ
   * æµæ°´çº¿ç”±å¤šä¸ª **stage** ç»„æˆ
   * stage é‡Œçš„ job é»˜è®¤å¹¶è¡Œæ‰§è¡Œï¼Œstage ä¸ stage ä¹‹é—´é¡ºåºæ‰§è¡Œ

2. **Stageï¼ˆé˜¶æ®µï¼‰**

   * `.gitlab-ci.yml` é‡Œçš„ `stages:` å®šä¹‰é¡ºåº
   * ä¾‹ï¼š`stages: ["build", "test", "deploy"]`
   * æœ¬è´¨ï¼š**æ§åˆ¶ job æ‰§è¡Œé¡ºåº**

3. **Jobï¼ˆä½œä¸šï¼‰**

   * stage é‡Œçš„å•ä¸ªä»»åŠ¡
   * å®šä¹‰ï¼šimageã€scriptã€variablesã€artifacts ç­‰
   * GitLab ä¼šä¸ºæ¯ä¸ª job **æ‰¾ Runner æ‰§è¡Œ**

4. **Runnerï¼ˆæ‰§è¡Œè€…ï¼‰**

   * å®é™…æ‰§è¡Œ job çš„æœºå™¨ / å®¹å™¨
   * GitLab åªè´Ÿè´£**è°ƒåº¦å’Œç®¡ç†**ï¼Œä¸åŠ¨æ‰‹æ‰§è¡Œå‘½ä»¤
   * ç±»å‹ï¼šshellã€dockerã€kubernetes ç­‰

---

## äºŒã€`.gitlab-ci.yml` æ–‡ä»¶çš„å¤„ç†æµç¨‹

å‡è®¾ä½ æœ‰ä¸€ä¸ªç®€å•æ–‡ä»¶ï¼š

```yaml
stages:
  - build
  - test

build:
  stage: build
  script:
    - echo "building"

test:
  stage: test
  script:
    - echo "testing"
```

### 1ï¸âƒ£ GitLab è§£æ `.gitlab-ci.yml`

* å‘ç”Ÿåœ¨ **Pipeline åˆ›å»ºæ—¶**
* GitLab ä¼šï¼š

  1. è¯»å– `.gitlab-ci.yml`
  2. éªŒè¯ YAML æ ¼å¼
  3. è§£æ stage é¡ºåº
  4. ç”Ÿæˆ job åˆ—è¡¨

> å¯¹åº”ä¸Šä¾‹ï¼Œç”Ÿæˆä¸¤æ¡ jobï¼š`build`ï¼ˆstage buildï¼‰ã€`test`ï¼ˆstage testï¼‰

---

### 2ï¸âƒ£ åˆ›å»º Pipeline å¯¹è±¡

GitLab ç”Ÿæˆä¸€ä¸ª **Pipeline å¯¹è±¡**ï¼š

```text
Pipeline #42
  Stage: build
    Job: build
  Stage: test
    Job: test
```

* Pipeline æ˜¯ä¸€æ¬¡æäº¤å¯¹åº”çš„è¿è¡Œå®ä¾‹
* æ¯ä¸ª job éƒ½æœ‰çŠ¶æ€ï¼špending â†’ running â†’ success/fail

---

### 3ï¸âƒ£ Job åˆ†å‘ç»™ Runner

* GitLab ä¼šæŠŠ job æ”¾åˆ° **Queue**
* Runner ä¼š **è½®è¯¢æˆ–è¢«é€šçŸ¥** æ‹‰å– job
* Job æ‹‰å–æˆåŠŸåï¼š

  1. GitLab æ ‡è®° job ä¸º running
  2. Runner åœ¨æŒ‡å®šç¯å¢ƒï¼ˆimage/executorï¼‰ä¸­æ‰§è¡Œ `script`

> å¦‚æœæ²¡æœ‰ Runnerï¼Œjob ä¼šä¸€ç›´ pending

---

### 4ï¸âƒ£ Job æ‰§è¡Œé¡ºåºä¸ä¾èµ–

* **Stage é¡ºåº**ï¼šstage1 å®Œæˆ â†’ stage2 æ‰å¼€å§‹
* **åŒä¸€ä¸ª stage**ï¼šå¤šä¸ª job å¹¶è¡Œ
* **Job ä¹‹é—´çš„ä¾èµ–**ï¼š

  * artifactsï¼ˆäº§ç‰©ï¼‰å¯ä»¥ä¼ é€’
  * cacheï¼ˆä¾èµ–ç¼“å­˜ï¼‰å¯ä»¥åŠ é€Ÿä¸‹æ¬¡æ„å»º

---

### 5ï¸âƒ£ Job æ‰§è¡Œç¯å¢ƒ

æ¯ä¸ª job éƒ½æ˜¯ **å¹²å‡€çš„æ‰§è¡Œç¯å¢ƒ**ï¼Œå¯ä»¥ç”¨ï¼š

* `image:` æŒ‡å®š Docker é•œåƒ
* `services:` æŒ‡å®šä¾èµ–æœåŠ¡ï¼ˆæ•°æ®åº“ã€docker:dindï¼‰
* `before_script:` / `after_script:` åšé€šç”¨æ“ä½œ

ä¾‹ï¼š

```yaml
build:
  stage: build
  image: docker:25
  services:
    - docker:25-dind
  before_script:
    - echo "prepare environment"
  script:
    - docker build -t myapp:1.0 .
```

Runner ä¼šï¼š

1. æ‹‰å– docker:25 é•œåƒä½œä¸º job ç¯å¢ƒ
2. å¯åŠ¨ docker:dind æœåŠ¡ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
3. æ‰§è¡Œ before_script + script
4. è¿”å›çŠ¶æ€ç»™ GitLab

---

### 6ï¸âƒ£ Job å®Œæˆåçš„å¤„ç†

* job æˆåŠŸ â†’ æ ‡è®° success
* job å¤±è´¥ â†’ Pipeline æŒ‚æ‰
* å¯é€‰ä¸Šä¼  artifactsï¼ˆæ„å»ºäº§ç‰©ï¼‰
* Pipeline é¡µé¢æ˜¾ç¤ºæ—¥å¿—

---

## ä¸‰ã€å…³é”®æœºåˆ¶æ€»ç»“

| æ¦‚å¿µ                | ä½œç”¨              | ç‰¹ç‚¹                     |
| ----------------- | --------------- | ---------------------- |
| Pipeline          | ä¸€æ¬¡æäº¤æˆ–è§¦å‘å¯¹åº”çš„å®Œæ•´æµæ°´çº¿ | stage æœ‰é¡ºåºï¼Œjob å¯ä»¥å¹¶è¡Œ     |
| Stage             | Job çš„é¡ºåºæ§åˆ¶       | é˜¶æ®µé—´ä¸¥æ ¼é¡ºåº                |
| Job               | çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„å•å…ƒ       | ç‹¬ç«‹ç¯å¢ƒã€å¯ç¼“å­˜ã€å¯ä¸Šä¼  artifacts |
| Runner            | Job æ‰§è¡Œè€…         | å¯å¤ç”¨ã€å¯åˆ†å¸ƒå¼ã€æ”¯æŒå¤š executor  |
| Cache / Artifacts | ä¾èµ–æˆ–æ„å»ºäº§ç‰©ä¼ é€’       | cache åŠ é€Ÿï¼Œartifact å…±äº«   |

---

## å››ã€Pipeline å·¥ä½œæµç¨‹æ€»ç»“å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰

```text
Git push / MR
      â”‚
      â–¼
GitLab è§£æ .gitlab-ci.yml
      â”‚
      â–¼
ç”Ÿæˆ Pipeline å¯¹è±¡
      â”‚
      â–¼
åˆ†é… Job ç»™ Runner
      â”‚
      â–¼
Runner æ‰§è¡Œ Job (script)
      â”‚
      â–¼
æ›´æ–° Job / Pipeline çŠ¶æ€
      â”‚
      â–¼
æˆåŠŸ â†’ Pipeline complete
å¤±è´¥ â†’ Pipeline fail
```

---

## äº”ã€æ ¸å¿ƒæœºåˆ¶è¦ç‚¹

1. **æ¯æ¬¡ pipeline ç‹¬ç«‹**ï¼šæ¯ä¸ª job éƒ½æ˜¯å¹²å‡€ç¯å¢ƒ
2. **ç¼“å­˜/äº§ç‰©å¯ä»¥ä¼ é€’**ï¼šä¿è¯ä¾èµ–å’Œæ„å»ºç‰©å¤ç”¨
3. **å¹¶è¡Œ & é¡ºåº**ï¼šstage å†…å¹¶è¡Œï¼Œstage é—´é¡ºåº
4. **Runner æ˜¯æ‰§è¡Œè€…ï¼Œä¸æ˜¯ GitLab**
5. **`.gitlab-ci.yml` æ˜¯å£°æ˜å¼è„šæœ¬**ï¼ŒGitLab è§£æåç”Ÿæˆä»»åŠ¡åˆ—è¡¨

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼ **å›¾è§£ç‰ˆ GitLab CI æ‰§è¡Œæµç¨‹**ï¼Œ
ä» `.gitlab-ci.yml` â†’ Pipeline â†’ Runner â†’ Job â†’ é•œåƒ/äº§ç‰©ä¸Šä¼ ï¼Œå…¨é“¾è·¯å¯è§†åŒ– ğŸ–¼ï¸

è¿™æ ·ä½ çœ‹åˆ°æ¯æ¡å‘½ä»¤ç©¶ç«Ÿâ€œå»å“ªäº†â€ï¼Œç†è§£ä¼šæ›´ç›´è§‚ã€‚

å¥½çš„ï¼Œæˆ‘æ¥ç»™ä½ è¯¦ç»†è®²è§£ `.gitlab-ci.yml` æ–‡ä»¶çš„ç»“æ„ã€æ ¼å¼å’Œå¸¸ç”¨å­—æ®µã€‚è¿™æ˜¯ GitLab CI/CD çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œç”¨ YAML å†™æˆï¼Œå®šä¹‰äº† Pipelineã€Stagesã€Jobs ç­‰ã€‚

---

## 1. åŸºç¡€ç»“æ„

ä¸€ä¸ªå…¸å‹ `.gitlab-ci.yml` åŒ…å«ï¼š

```yaml
stages:          # é˜¶æ®µå®šä¹‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤é¡ºåºæ˜¯ jobs åç§°é¡ºåºï¼‰
  - build
  - test
  - deploy

job_name:        # Job åç§°
  stage: build   # æŒ‡å®šé˜¶æ®µï¼ˆå¿…é¡»åœ¨ stages ä¸­ï¼‰
  script:        # æ‰§è¡Œè„šæœ¬å‘½ä»¤ï¼ˆå¿…é¡»ï¼‰
    - echo "Hello World"
  tags:          # å¯é€‰ï¼ŒRunner æ ‡ç­¾
    - docker
  only:          # å¯é€‰ï¼Œè§¦å‘æ¡ä»¶
    - main
  except:        # å¯é€‰ï¼Œæ’é™¤æ¡ä»¶
    - develop
  artifacts:     # å¯é€‰ï¼Œäº§ç‰©æ–‡ä»¶
    paths:
      - dist/
    expire_in: 1 week
  when:          # å¯é€‰ï¼Œæ‰§è¡Œæ—¶æœºï¼šon_success/on_failure/always/manual
    - on_success
  retry: 2       # å¯é€‰ï¼Œå¤±è´¥é‡è¯•æ¬¡æ•°
```

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### (1) **stages**

* å®šä¹‰ Pipeline çš„é˜¶æ®µé¡ºåºã€‚
* Jobs å±äºæŸä¸ª stageï¼Œstage å®Œæˆåæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ª stageã€‚
* ç¤ºä¾‹ï¼š

```yaml
stages:
  - build
  - test
  - deploy
```

### (2) **job**

* Pipeline çš„æœ€å°æ‰§è¡Œå•å…ƒã€‚
* å¿…é¡»è‡³å°‘åŒ…å« `script`ã€‚
* å¯é€‰å­—æ®µå¾ˆå¤šï¼Œå¸¸ç”¨çš„æœ‰ï¼š

  * `stage`ï¼šæŒ‡å®šé˜¶æ®µã€‚
  * `tags`ï¼šåŒ¹é… Runner æ ‡ç­¾ã€‚
  * `only` / `except`ï¼šé™åˆ¶æ‰§è¡Œæ¡ä»¶ã€‚
  * `artifacts`ï¼šJob äº§ç‰©ã€‚
  * `when`ï¼šæ‰§è¡Œæ—¶æœºã€‚
  * `retry`ï¼šå¤±è´¥é‡è¯•æ¬¡æ•°ã€‚

### (3) **script**

* Job æ‰§è¡Œçš„å‘½ä»¤åºåˆ—ã€‚
* æ”¯æŒå¤šè¡Œï¼š

```yaml
script:
  - echo "Start build"
  - make all
  - echo "Build finished"
```

### (4) **tags**

* Runner æ ‡ç­¾åŒ¹é…ã€‚
* Job åªæœ‰åŒ¹é…æ ‡ç­¾çš„ Runner æ‰èƒ½æ‰§è¡Œã€‚

```yaml
tags:
  - docker
  - ubuntu
```

### (5) **only / except**

* æ§åˆ¶ Job æ‰§è¡Œæ¡ä»¶ã€‚

```yaml
only:
  - main
  - tags
except:
  - develop
```

* æ”¯æŒåˆ†æ”¯åã€æ ‡ç­¾ã€å˜é‡ã€pipeline ç±»å‹ç­‰ã€‚

### (6) **artifacts**

* å®šä¹‰ Job ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä¾›åç»­ Job ä½¿ç”¨æˆ–ä¸‹è½½ã€‚

```yaml
artifacts:
  paths:
    - build/
  expire_in: 1 week
```

### (7) **when**

* æ§åˆ¶ Job æ‰§è¡Œæ—¶æœºï¼š

  * `on_success`ï¼ˆé»˜è®¤ï¼‰: å‰é¢é˜¶æ®µæˆåŠŸæ—¶æ‰§è¡Œ
  * `on_failure`ï¼šå‰é¢é˜¶æ®µå¤±è´¥æ—¶æ‰§è¡Œ
  * `always`ï¼šæ€»æ˜¯æ‰§è¡Œ
  * `manual`ï¼šæ‰‹åŠ¨è§¦å‘

### (8) **retry**

* Job æ‰§è¡Œå¤±è´¥æ—¶é‡è¯•æ¬¡æ•°ã€‚

```yaml
retry: 2
```

---

## 3. é«˜çº§åŠŸèƒ½

### (1) **variables**

* å®šä¹‰ CI/CD å˜é‡ï¼Œå¯åœ¨è„šæœ¬ä¸­ä½¿ç”¨ï¼š

```yaml
variables:
  NODE_ENV: production
  API_URL: "https://api.example.com"
```

### (2) **includes**

* å¼•å…¥å…¶ä»– YAML æ–‡ä»¶ï¼Œæ–¹ä¾¿å¤ç”¨ï¼š

```yaml
include:
  - local: '/ci-templates/base.yml'
```

### (3) **dependencies**

* Job å¯ä»¥ä¾èµ–å‰ä¸€ä¸ª Job çš„ artifactï¼š

```yaml
job2:
  stage: test
  dependencies:
    - job1
```

### (4) **extends**

* å¤ç”¨å·²æœ‰ Job é…ç½®ï¼š

```yaml
.build_template:
  script:
    - echo "Building"

job1:
  extends: .build_template
  stage: build
```

---

## 4. ç¤ºä¾‹ Pipeline

```yaml
stages:
  - build
  - test
  - deploy

build_job:
  stage: build
  script:
    - echo "Build project"
    - make build
  tags:
    - docker
  artifacts:
    paths:
      - build/

test_job:
  stage: test
  script:
    - echo "Run tests"
    - make test
  dependencies:
    - build_job

deploy_job:
  stage: deploy
  script:
    - echo "Deploying"
  only:
    - main
```

---

âœ… **æ€»ç»“**ï¼š

* `.gitlab-ci.yml` æ˜¯ Pipeline çš„çµé­‚ã€‚
* æ ¸å¿ƒå…ƒç´ æ˜¯ **stages** å’Œ **job**ï¼Œjob å¿…é¡»æœ‰ scriptã€‚
* å¯é€‰å­—æ®µï¼ˆtags, only/except, artifacts, variablesï¼‰è®© CI/CD æ›´çµæ´»ã€‚
* é«˜çº§ç‰¹æ€§ï¼ˆextends, include, dependenciesï¼‰æ–¹ä¾¿å›¢é˜Ÿå¤ç”¨é…ç½®ã€‚

---

æˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼ **Pipeline é˜¶æ®µ â†’ Job â†’ Runner æ‰§è¡Œ â†’ artifacts æµç¨‹å›¾**ï¼Œè®©æ•´ä¸ª `.gitlab-ci.yml` çš„ä½œç”¨å’Œæµç¨‹æ›´ç›´è§‚ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ

