好的，我给你整理一个 **可直接用的 Docker Compose 配置**，在同一台机器上部署 **GitLab CE + GitLab Runner**，并保证 **本地镜像可用、端口映射合理、数据持久化**。

------

## **Docker Compose 文件示例**

```yaml
version: '3.8'

services:
  gitlab:
    image: gitlab/gitlab-ce:18.4.6-ce.0
    container_name: gitlab
    restart: always
    hostname: gitlab.jsy.com
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.jsy.com'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        gitlab_rails['gitlab_ci_shared_runners_enabled'] = true
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "2222:22"     # Git SSH
    volumes:
      - ./gitlab/config:/etc/gitlab
      - ./gitlab/logs:/var/log/gitlab
      - ./gitlab/data:/var/opt/gitlab
    networks:
      - gitlab-net

  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner
    restart: always
    depends_on:
      - gitlab
    volumes:
      - ./runner/config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner/local-images:/var/lib/docker
      - ./gitlab/config/trusted-certs:/etc/gitlab-runner/certs:ro
    networks:
      - gitlab-net
    environment:
      RUNNER_CONCURRENT: 1

networks:
  gitlab-net:
    driver: bridge
```

------

## **部署步骤**

1. **保存 Docker Compose 文件**

```bash
nano docker-compose.yml
# 粘贴上面的内容
```

2. **启动 GitLab 和 Runner**

```bash
docker-compose up -d
```

3. **访问 GitLab**

- 浏览器访问 `http://<宿主机IP>/`

- 初次登录需要设置 root 密码

  ```
  root@ubuntu2204:~# cat gitlab/config/initial_root_password
  Password: 0B9p95lS8dzPRvgYCB2JX0wiZKJrSwjfUU1Wa3FOTvY=
  ```

  

4. **注册 Runner**

```bash
docker exec -it gitlab-runner gitlab-runner register
```

注册信息示例：

| 提示          | 示例                                        |
| ------------- | ------------------------------------------- |
| GitLab URL    | `http://gitlab:80/`                         |
| Token         | GitLab 项目 -> Settings -> CI/CD -> Runners |
| Description   | `local-runner`                              |
| Tags          | `docker,local`                              |
| Executor      | `docker`                                    |
| Default Image | `my-local-image:latest`                     |

1. **构建本地 Docker 镜像**（Runner 使用）

```bash
docker build -t my-local-image:latest ./ci
```

1. **编写 `.gitlab-ci.yml`**

```yaml
stages:
  - build
  - test

build-job:
  stage: build
  tags:
    - docker
    - local
  script:
    - echo "Build stage using local Docker image"
    - python --version

test-job:
  stage: test
  tags:
    - docker
    - local
  script:
    - python -c "print('Hello from Runner')"
```

1. **触发 Pipeline**

- Push `.gitlab-ci.yml` 到 GitLab
- Pipeline 自动执行

------

✅ 这个 Compose 配置已经：

- **挂载持久化卷**，保证数据不会丢失
- **Runner 使用宿主机 Docker**，可复用本地镜像
- **端口分离**，HTTP/HTTPS/SSH 不冲突
- **网络隔离**，容器内部互联

------



#  `docker-compose.yaml` 文件说明

------

## **1. 版本声明**

```yaml
version: '3.8'
```

- 指定 Docker Compose 文件的版本
- `3.8` 支持最新的 Docker 功能（如网络、依赖、资源限制）

------

## **2. 服务定义**

### **2.1 GitLab CE**

```yaml
gitlab:
  image: gitlab/gitlab-ce:18.4.6-ce.0
  container_name: gitlab
  restart: always
  hostname: gitlab.local
```

- `image`：指定 GitLab 社区版镜像和版本
- `container_name`：容器名称
- `restart: always`：容器异常退出自动重启
- `hostname`：GitLab 内部使用的主机名

------

#### **环境变量**

```yaml
environment:
  GITLAB_OMNIBUS_CONFIG: |
    external_url 'http://gitlab.local'
    gitlab_rails['gitlab_shell_ssh_port'] = 2222
    gitlab_rails['gitlab_ci_shared_runners_enabled'] = true
```

- `external_url`：访问 GitLab 的 URL，Runner 和浏览器都用这个
- `gitlab_shell_ssh_port`：Git SSH 默认端口改为 2222，避免宿主机 22 冲突
- `gitlab_ci_shared_runners_enabled`：开启共享 Runner

------

#### **端口映射**

```yaml
ports:
  - "80:80"       # HTTP
  - "443:443"     # HTTPS
  - "2222:22"     # Git SSH
```

- 左边宿主机端口，右边容器端口
- 映射保证宿主机和外部网络可以访问 GitLab

------

#### **数据卷挂载**

```yaml
volumes:
  - ./gitlab/config:/etc/gitlab
  - ./gitlab/logs:/var/log/gitlab
  - ./gitlab/data:/var/opt/gitlab
```

- `/etc/gitlab`：GitLab 配置文件
- `/var/log/gitlab`：日志
- `/var/opt/gitlab`：GitLab 数据库、仓库数据
- 保证容器重启或重建不会丢失数据

------

#### **网络**

```yaml
networks:
  - gitlab-net
```

- 将 GitLab 放入自定义 Docker 网络，便于 Runner 内网访问

------

### **2.2 GitLab Runner**

```yaml
gitlab-runner:
  image: gitlab/gitlab-runner:latest
  container_name: gitlab-runner
  restart: always
  depends_on:
    - gitlab
```

- `image`：Runner 官方镜像
- `depends_on`：确保 GitLab 先启动，再启动 Runner

------

#### **挂载卷**

```yaml
volumes:
  - ./runner/config:/etc/gitlab-runner
  - /var/run/docker.sock:/var/run/docker.sock
  - ./runner/local-images:/var/lib/docker
```

- `/etc/gitlab-runner`：Runner 配置和注册信息
- `/var/run/docker.sock`：允许 Runner 调用宿主机 Docker 构建镜像
- `/var/lib/docker`：存储本地 Docker 镜像缓存，让 Runner 能复用

------

#### **网络**

```yaml
networks:
  - gitlab-net
```

- 与 GitLab 在同一网络，容器内部可以通过 `gitlab` hostname 访问

------

#### **环境变量**

```yaml
environment:
  RUNNER_CONCURRENT: 1
```

- 限制 Runner 并发构建数为 1，防止同机资源被抢占

------

## **3. 网络定义**

```yaml
networks:
  gitlab-net:
    driver: bridge
```

- 自定义网络 `gitlab-net`，桥接模式
- 让 GitLab 和 Runner 容器可以互相访问，但与宿主机网络隔离

------

## **总结**

1. **GitLab CE**：提供 Git 仓库和 CI/CD 服务
2. **GitLab Runner**：执行 CI/CD Job，调用宿主机 Docker
3. **数据持久化**：保证容器重启不丢数据
4. **端口分离**：HTTP/HTTPS/SSH 不冲突
5. **内部网络**：Runner 与 GitLab CE 内网通信
6. **资源控制**：Runner 并发为 1，避免同机 CPU 内存竞争

------

如果你需要，我可以帮你画一张 **GitLab CE + Runner 同机部署架构图**，标明网络、卷挂载、端口映射和本地镜像使用流程，会更直观。

你希望我画吗？
